{% extends 'base.html' %}
{% block title %}Admin Paneli Â· Pilates Studio{% endblock %}

{% block content %}

{# Ä°statistik KartlarÄ± #}
<div class="grid md:grid-cols-3 gap-6">
  <div class="rounded-2xl border border-white/55 bg-white/55 backdrop-blur-xl p-5 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <div class="flex items-center gap-3">
      <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-rose-200 to-violet-200 shadow-inner">ğŸ—“ï¸</span>
      <div class="flex-1">
        <div class="text-xs text-stone-500">Toplam Seans</div>
        <div class="text-2xl font-semibold">{{ total_sessions }}</div>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-white/55 bg-white/55 backdrop-blur-xl p-5 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <div class="flex items-center gap-3">
      <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-amber-200 to-pink-200 shadow-inner">â±ï¸</span>
      <div class="flex-1">
        <div class="text-xs text-stone-500">YaklaÅŸan</div>
        <div class="text-2xl font-semibold">{{ upcoming }}</div>
      </div>
    </div>
  </div>

  <div class="rounded-2xl border border-white/55 bg-white/55 backdrop-blur-xl p-5 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
    <div class="flex items-center gap-3">
      <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-emerald-200 to-teal-200 shadow-inner">ğŸ‘¥</span>
      <div class="flex-1">
        <div class="text-xs text-stone-500">Aktif Rezervasyon</div>
        <div class="text-2xl font-semibold">{{ active_res }}</div>
      </div>
    </div>
  </div>
</div>

{# Doluluk Ä°lerleme Ã‡ubuÄŸu #}
{% set cap  = today_cap  or 0 %}
{% set fill = today_fill or 0 %}
{% set pct  = (fill * 100 // cap) if cap else 0 %}
{% set pct_int = pct|int %}

<div class="rounded-2xl border border-white/55 bg-white/55 backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)] mt-6">
  <div class="flex items-center justify-between">
    <div class="text-sm text-stone-500">BugÃ¼n doluluk</div>
    <div class="text-sm font-medium">{{ today_fill }} / {{ today_cap }}</div>
  </div>

  <div class="mt-3 h-3 w-full rounded-full bg-white/70 ring-1 ring-white/60 shadow-inner overflow-hidden">
    <div class="progress-fill h-full rounded-full bg-gradient-to-r from-rose-300 via-fuchsia-300 to-violet-300 transition-all"
         style="width: {{ pct_int }}%;"></div>
  </div>

  <div class="mt-2 text-[12px] text-stone-500">{{ pct_int }}%</div>
</div>

{# HÄ±zlÄ± EriÅŸim ButonlarÄ± #}
<div class="mt-6 flex flex-wrap gap-3">
  <a href="{{ url_for('admin.sessions') }}"
     class="inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-gradient-to-r from-rose-300 to-violet-300 text-stone-900 shadow hover:shadow-md">
    ğŸ§­ SeanslarÄ± YÃ¶net
  </a>
  <a href="{{ url_for('admin.members') }}"
     class="inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-white/80 border border-white/60 backdrop-blur shadow hover:bg-white">
    ğŸ‘¤ Ãœyeler
  </a>
  
  <div class="relative group">
      <button id="openMeasurementModal" type="button" class="inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-emerald-100 text-emerald-900 shadow hover:shadow-md transition">
        ğŸ“ Ã–lÃ§Ã¼m Paneli
        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
      </button>
  </div>

  <a href="{{ url_for('admin.list_cancel_requests') }}"
     class="inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-amber-200 text-amber-900 shadow hover:shadow-md">
    âŒ Ä°ptal Talepleri
    <span class="ml-1 inline-flex items-center justify-center px-2 py-0.5 text-xs font-semibold bg-white/70 rounded-full">
      {{ pending_count }}
    </span>
  </a>
</div>

<div class="mt-6 rounded-2xl border border-white/55 bg-white/55 backdrop-blur-xl p-5 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">
  <div class="text-sm text-stone-500">Bekleyen Ä°ptal</div>
  <div class="text-2xl font-semibold">{{ pending_count }}</div>
</div>

<div id="measurementModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm hidden">
  <div class="bg-white/95 rounded-2xl p-6 w-full max-w-2xl shadow-xl relative max-h-[90vh] overflow-y-auto">
    <button id="closeMeasurementModal" type="button" class="absolute top-3 right-3 text-stone-400 hover:text-stone-700 text-xl">&times;</button>
    <h3 class="text-lg font-semibold mb-4">Ãœye Ã–lÃ§Ã¼m Paneli</h3>
    <div class="mb-4">
      <label class="block mb-2 text-sm font-medium">Ãœye SeÃ§</label>
      <select id="modalMemberSelect" class="w-full p-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-300">
        <option value="">Ãœye seÃ§iniz...</option>
        {% for m in members %}
          <option value="{{ m.id }}">{{ m.full_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div id="measurementContent" class="min-h-[100px]"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Flask route URL ÅŸablonlarÄ±nÄ± JS deÄŸiÅŸkenlerine atÄ±yoruz
  const BASE_LIST_URL = "{{ url_for('admin.member_measurements', member_id=0) }}";
  const BASE_ADD_URL  = "{{ url_for('admin.add_measurement', member_id=0) }}";

  document.addEventListener('DOMContentLoaded', () => {
    const openBtn = document.getElementById('openMeasurementModal');
    const modal = document.getElementById('measurementModal');
    const closeBtn = document.getElementById('closeMeasurementModal');
    const memberSelect = document.getElementById('modalMemberSelect');
    const contentDiv = document.getElementById('measurementContent');

    if (openBtn && modal) openBtn.onclick = () => modal.classList.remove('hidden');
    if (closeBtn && modal) closeBtn.onclick = () => modal.classList.add('hidden');
    if (modal) {
      modal.onclick = (e) => {
        if (e.target === modal) modal.classList.add('hidden');
      };
    }

    if (memberSelect && contentDiv) {
      memberSelect.addEventListener('change', async () => {
        const id = memberSelect.value;
        if (!id) {
          contentDiv.innerHTML = '';
          return;
        }

        contentDiv.innerHTML = '<div class="text-center text-stone-400 py-4">YÃ¼kleniyor...</div>';

        // URL'lerdeki 0'Ä± seÃ§ilen ID ile deÄŸiÅŸtir
        const listUrl = BASE_LIST_URL.replace('/0', '/' + id);
        const addUrl  = BASE_ADD_URL.replace('/0', '/' + id);

        try {
          const [listRes, formRes] = await Promise.all([
            fetch(listUrl),
            fetch(addUrl)
          ]);

          const listHtml = await listRes.text();
          const formHtml = await formRes.text();

          const parser = new DOMParser();
          
          // Formu Ã§ek
          const formDoc = parser.parseFromString(formHtml, 'text/html');
          let formElement = formDoc.querySelector('form');

          // Tabloyu Ã§ek
          const listDoc = parser.parseFromString(listHtml, 'text/html');
          const listContent = listDoc.querySelector('table') || listDoc.querySelector('.space-y-3');

          let finalHtml = '';
          
          if (formElement) {
            formElement.setAttribute('action', addUrl);
            formElement.id = 'ajaxAddForm';
            finalHtml += `<div class="mb-6">${formElement.outerHTML}</div>`;
          } else {
             // Form bulunamazsa konsola hata bas
             console.error("Form bulunamadÄ±! Gelen HTML:", formHtml);
             finalHtml += '<div class="text-red-500 text-sm mb-4">Form yÃ¼klenemedi. (Åablon dosyalarÄ±nÄ± kontrol edin)</div>';
          }

          if (listContent) {
            finalHtml += `<div>${listContent.outerHTML}</div>`;
          } else {
            finalHtml += '<div class="text-stone-500 mt-4 text-center text-sm">HenÃ¼z kayÄ±tlÄ± Ã¶lÃ§Ã¼m yok.</div>';
          }

          contentDiv.innerHTML = finalHtml;

        } catch (err) {
          console.error(err);
          contentDiv.innerHTML = '<div class="text-red-500">Veriler yÃ¼klenirken hata oluÅŸtu.</div>';
        }
      });
    }

    contentDiv.addEventListener('submit', async (e) => {
      const form = e.target;
      if (form.id === 'ajaxAddForm' || form.action.includes('delete')) {
        e.preventDefault();
        if (form.action.includes('delete') && !confirm('Silinsin mi?')) return;

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {'X-Requested-With': 'XMLHttpRequest'}
          });

          if (res.ok || res.redirected) {
            memberSelect.dispatchEvent(new Event('change')); // Listeyi yenile
          } else {
            alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z.');
          }
        } catch (err) {
          console.error(err);
          alert('Hata oluÅŸtu.');
        }
      }
    });
  });
</script>
{% endblock %}