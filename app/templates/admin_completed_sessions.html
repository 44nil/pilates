{% extends 'base.html' %}

{% block title %}Tamamlanan Seanslar{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-6xl space-y-8">
  <!-- Başlık -->
  <div class="flex items-center justify-between">
    <h1 class="text-3xl font-bold text-stone-800">Tamamlanan Seanslar</h1>
    <div class="flex items-center gap-3">
      <a href="{{ url_for('admin.dashboard') }}" class="py-2 px-4 rounded-xl bg-stone-100 hover:bg-stone-200 transition text-sm">
        ← Dashboard
      </a>
      <a href="{{ url_for('admin.sessions') }}" class="py-2 px-4 rounded-xl bg-stone-100 hover:bg-stone-200 transition text-sm">
        Aktif Seanslar
      </a>
    </div>
  </div>

  <!-- İstatistikler -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="rounded-xl bg-white/55 backdrop-blur-xl p-4 shadow-sm ring-1 ring-white/50">
      <h3 class="text-sm font-medium text-stone-500">Toplam Tamamlanan Seans</h3>
      <p class="mt-2 text-2xl font-bold">{{ completed_sessions|length }}</p>
    </div>
    <div class="rounded-xl bg-white/55 backdrop-blur-xl p-4 shadow-sm ring-1 ring-white/50">
      <h3 class="text-sm font-medium text-stone-500">Toplam Katılım</h3>
      <p class="mt-2 text-2xl font-bold">{{ total_attendance }}</p>
    </div>
    <div class="rounded-xl bg-white/55 backdrop-blur-xl p-4 shadow-sm ring-1 ring-white/50">
      <h3 class="text-sm font-medium text-stone-500">Tamamlanma Oranı</h3>
      <p class="mt-2 text-2xl font-bold">%{{ completion_rate }}</p>
    </div>
  </div>

  <!-- Filtreler -->
  <div class="rounded-xl bg-white/55 backdrop-blur-xl p-6 shadow-sm ring-1 ring-white/50">
    <h2 class="font-semibold mb-4">Filtrele</h2>
    <form method="get" action="{{ url_for('admin.completed_sessions') }}">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label for="date_from" class="block text-sm font-medium text-stone-600">Tarihten</label>
          <input type="date" id="date_from" name="date_from" value="{{ request.args.get('date_from', '') }}" 
                 class="mt-1 block w-full rounded-md border-stone-300 shadow-sm">
        </div>
        <div>
          <label for="date_to" class="block text-sm font-medium text-stone-600">Tarihe</label>
          <input type="date" id="date_to" name="date_to" value="{{ request.args.get('date_to', '') }}"
                 class="mt-1 block w-full rounded-md border-stone-300 shadow-sm">
        </div>
        <div class="flex items-end">
          <button type="submit" class="py-2 px-4 w-full rounded-xl bg-stone-800 text-white hover:bg-stone-700 transition">
            Filtrele
          </button>
        </div>
        <div class="flex items-end">
          <a href="{{ url_for('admin.completed_sessions') }}" class="py-2 px-4 w-full rounded-xl bg-stone-100 text-center hover:bg-stone-200 transition">
            Filtreleri Temizle
          </a>
        </div>
      </div>
    </form>
  </div>

  <!-- Tamamlanan Seanslar Tablosu -->
  <div class="rounded-xl bg-white/55 backdrop-blur-xl p-6 shadow-sm ring-1 ring-white/50">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-semibold text-lg">Geçmiş Seanslar</h2>
      <div>
        <button type="button" id="exportButton" class="py-1 px-3 text-xs rounded-full bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200 shadow-sm hover:bg-emerald-200 transition">
          Excel'e Aktar
        </button>
      </div>
    </div>

    {% if completed_sessions %}
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-xl" id="completedSessionsTable">
          <thead class="bg-stone-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold text-stone-600 tracking-wider">#</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-stone-600 tracking-wider">Tarih</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-stone-600 tracking-wider">Saat</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-stone-600 tracking-wider">Kapasite</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-stone-600 tracking-wider">Katılanlar</th>
              <th class="px-4 py-3 text-left text-xs font-semibold text-stone-600 tracking-wider">Detaylar</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-stone-200">
            {% for session in completed_sessions %}
              <tr class="hover:bg-stone-50">
                <td class="px-4 py-2 text-sm">{{ session.id }}</td>
                <td class="px-4 py-2 text-sm">
                  {% set day_name = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'][session.date.weekday()] %}
                  <span class="text-xs font-medium text-violet-700 mr-1">{{ day_name }}</span>
                  {{ session.date.strftime('%d.%m.%Y') }}
                </td>
                <td class="px-4 py-2 text-sm">{{ session.time.strftime('%H:%M') }}</td>
                <td class="px-4 py-2 text-sm">{{ session.capacity }}</td>
                <td class="px-4 py-2 text-sm">
                  {% set attendance_count = session.get_attendance_count() %}
                  <span class="inline-flex items-center gap-1">
                    {{ attendance_count }} / {{ session.capacity }}
                    <span class="w-2 h-2 rounded-full bg-{{ 'emerald' if attendance_count/session.capacity >= 0.7 else 'amber' if attendance_count/session.capacity >= 0.3 else 'rose' }}-500"></span>
                  </span>
                </td>
                <td class="px-4 py-2 text-sm">
                  <button type="button" 
                          onclick="showSessionDetails('{{ session.id }}')"
                          class="text-indigo-600 hover:text-indigo-900 underline text-xs">
                    Detaylar
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-12 text-stone-500">
        <p>Tamamlanan seans bulunamadı.</p>
        <p class="text-sm mt-2">Filtreleri değiştirerek tekrar deneyebilirsiniz.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Session Detayları Modal -->
<div id="sessionDetailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold" id="modalTitle">Seans Detayları</h3>
      <button type="button" onclick="closeModal()" class="text-stone-500 hover:text-stone-800">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    <div id="modalContent">
      <div class="animate-pulse">
        <div class="h-4 bg-stone-200 rounded w-3/4 mb-2"></div>
        <div class="h-4 bg-stone-200 rounded w-1/2 mb-6"></div>
        <div class="h-4 bg-stone-200 rounded w-full mb-2"></div>
        <div class="h-4 bg-stone-200 rounded w-full mb-2"></div>
        <div class="h-4 bg-stone-200 rounded w-2/3"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  function showSessionDetails(sessionId) {
    // Modal'ı göster
    document.getElementById('sessionDetailModal').classList.remove('hidden');
    document.getElementById('modalContent').innerHTML = `
      <div class="animate-pulse">
        <div class="h-4 bg-stone-200 rounded w-3/4 mb-2"></div>
        <div class="h-4 bg-stone-200 rounded w-1/2 mb-6"></div>
        <div class="h-4 bg-stone-200 rounded w-full mb-2"></div>
        <div class="h-4 bg-stone-200 rounded w-full mb-2"></div>
        <div class="h-4 bg-stone-200 rounded w-2/3"></div>
      </div>
    `;
    
    // AJAX ile seans detaylarını getir
    fetch(`/api/session/${sessionId}/details`)
      .then(response => response.json())
      .then(data => {
        let attendeesHtml = '';
        if (data.attendees && data.attendees.length > 0) {
          attendeesHtml = `
            <h4 class="font-semibold mt-4 mb-2">Katılımcılar</h4>
            <ul class="divide-y divide-stone-200">
              ${data.attendees.map(attendee => `
                <li class="py-2 flex items-center justify-between">
                  <span>${attendee.name}</span>
                  <span class="text-xs ${attendee.status === 'attended' ? 'text-emerald-600' : 'text-rose-600'}">
                    ${attendee.status === 'attended' ? 'Katıldı' : 'Katılmadı'}
                  </span>
                </li>
              `).join('')}
            </ul>
          `;
        } else {
          attendeesHtml = `
            <div class="mt-4 py-3 text-center text-stone-500 bg-stone-50 rounded-lg">
              <p>Bu seansa katılımcı kaydı bulunamadı.</p>
            </div>
          `;
        }
        
        document.getElementById('modalContent').innerHTML = `
          <div class="mb-4 pb-4 border-b border-stone-200">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <p class="text-xs text-stone-500">Tarih</p>
                <p>${data.date}</p>
              </div>
              <div>
                <p class="text-xs text-stone-500">Saat</p>
                <p>${data.time}</p>
              </div>
              <div>
                <p class="text-xs text-stone-500">Kapasite</p>
                <p>${data.capacity}</p>
              </div>
              <div>
                <p class="text-xs text-stone-500">Doluluk Oranı</p>
                <p>${data.attendanceRate}%</p>
              </div>
            </div>
            ${data.notes ? `
              <div class="mt-4">
                <p class="text-xs text-stone-500">Notlar</p>
                <p>${data.notes}</p>
              </div>
            ` : ''}
          </div>
          ${attendeesHtml}
        `;
      })
      .catch(error => {
        document.getElementById('modalContent').innerHTML = `
          <div class="text-center py-8 text-rose-600">
            <p>Detaylar yüklenirken bir hata oluştu.</p>
            <p class="text-sm mt-2">${error.message || 'Lütfen tekrar deneyin.'}</p>
          </div>
        `;
      });
  }
  
  function closeModal() {
    document.getElementById('sessionDetailModal').classList.add('hidden');
  }
  
  // Modal dışına tıklandığında kapatma
  document.getElementById('sessionDetailModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
  
  // Excel'e aktarma fonksiyonu
  document.getElementById('exportButton').addEventListener('click', async function() {
    // Loading göstergesi
    const button = this;
    const originalText = button.textContent;
    button.textContent = 'Hazırlanıyor...';
    button.disabled = true;
    
    try {
      // Tüm seansların detaylarını topla
      const sessions = [];
      const rows = document.querySelectorAll('#completedSessionsTable tbody tr');
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const sessionId = row.cells[0].textContent.trim();
        
        try {
          const response = await fetch(`/api/session/${sessionId}/details`);
          const data = await response.json();
          
          sessions.push({
            id: sessionId,
            date: data.date,
            time: data.time,
            capacity: data.capacity,
            attendanceRate: data.attendanceRate,
            notes: data.notes || '',
            attendees: data.attendees || []
          });
        } catch (error) {
          console.error(`Seans ${sessionId} detayları alınamadı:`, error);
          // Temel bilgileri satırdan al
          sessions.push({
            id: sessionId,
            date: row.cells[1].textContent.trim(),
            time: row.cells[2].textContent.trim(),
            capacity: row.cells[3].textContent.trim(),
            attendanceRate: 'Bilinmiyor',
            notes: '',
            attendees: []
          });
        }
      }
      
      // Excel HTML içeriği oluştur
      let excelContent = `
        <table border="1" cellpadding="5" cellspacing="0">
          <thead>
            <tr>
              <th>Seans ID</th>
              <th>Tarih</th>
              <th>Saat</th>
              <th>Kapasite</th>
              <th>Doluluk Oranı</th>
              <th>Notlar</th>
              <th>Katılımcılar</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      sessions.forEach(session => {
        const attendeesText = session.attendees.length > 0 
          ? session.attendees.map(a => `${a.name} (${a.status === 'attended' ? 'Katıldı' : 'Katılmadı'})`).join(', ')
          : 'Katılımcı yok';
          
        excelContent += `
          <tr>
            <td>${session.id}</td>
            <td>${session.date}</td>
            <td>${session.time}</td>
            <td>${session.capacity}</td>
            <td>%${session.attendanceRate}</td>
            <td>${session.notes}</td>
            <td>${attendeesText}</td>
          </tr>
        `;
      });
      
      excelContent += `
          </tbody>
        </table>
      `;
      
      // Excel dosyası oluştur ve indir
      const uri = 'data:application/vnd.ms-excel;base64,';
      const template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>{table}</body></html>';
      const base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) };
      const format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) };
      
      const ctx = {worksheet: 'TamamlananSeanslar', table: excelContent};
      const link = document.createElement("a");
      link.download = "tamamlanan_seanslar_" + new Date().toISOString().slice(0,10) + ".xls";
      link.href = uri + base64(format(template, ctx));
      link.click();
      
    } catch (error) {
      console.error('Excel export hatası:', error);
      alert('Excel dosyası oluşturulurken bir hata oluştu. Lütfen tekrar deneyin.');
    } finally {
      // Butonu geri yükle
      button.textContent = originalText;
      button.disabled = false;
    }
  });
</script>
{% endblock %}
