{% extends 'base.html' %}
{% block title %}Haftalık Takvim · Pilates Studio{% endblock %}

{% block content %}
<!-- DEBUG: Backend'den gelen by_cell verisi (okunabilir JSON) -->
<pre class="text-xs">{{ by_cell|tojson }}</pre>

{% set gunler = {
  'Monday': 'Pazartesi', 'Tuesday': 'Salı', 'Wednesday': 'Çarşamba', 'Thursday': 'Perşembe',
  'Friday': 'Cuma', 'Saturday': 'Cumartesi'
} %}

{% set gunler_kisa = {
  'Mon': 'Pzt', 'Tue': 'Sal', 'Wed': 'Çar', 'Thu': 'Per',
  'Fri': 'Cum', 'Sat': 'Cmt'
} %}

<div class="rounded-[22px] border border-white/55 bg-transparent backdrop-blur-xl p-6 shadow-[0_20px_80px_-30px_rgba(0,0,0,.25)]">

  <!-- Üst bar: hafta başlığı + navigasyon -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="font-semibold text-lg">Haftalık Takvim</h2>
      <div class="text-xs text-stone-500">{{ week_label }}</div>
    </div>
    <div class="flex items-center gap-2">
      <a href="{{ url_for('sessions_calendar', d=prev_week) }}"
         class="rounded-xl px-3 py-1 ring-1 ring-white/60 bg-white/70 shadow hover:shadow-md">← Önceki</a>
      <a href="{{ url_for('sessions_calendar', d=next_week) }}"
         class="rounded-xl px-3 py-1 ring-1 ring-white/60 bg-white/70 shadow hover:shadow-md">Sonraki →</a>
    </div>
  </div>

  <!-- Legend -->
  <div class="flex flex-wrap gap-3 text-xs mb-4">
    <span class="inline-flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-gradient-to-r from-rose-300 to-violet-300 ring-1 ring-white/60"></span> Uygun
    </span>
    <span class="inline-flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-gray-300"></span> Dolu
    </span>
    <span class="inline-flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-emerald-300 ring-1 ring-white/60"></span> Katıldım
    </span>
    <span class="inline-flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-amber-300 ring-1 ring-white/60"></span> Özel Grup
    </span>
  </div>

  <!-- Grid -->
  <div class="overflow-auto rounded-2xl bg-transparent ring-0 shadow-none">
    <!-- Desktop Grid -->
    <div class="hidden md:grid" style="grid-template-columns: 90px repeat(6, minmax(160px,1fr));">

      <!-- Üst sol boş hücre -->
  <div class="sticky top-0 z-10 pastel-pink-bg" style="background:rgba(244,114,182,0.28) !important;"></div>

      <!-- Gün başlıkları (yarı saydam) -->
      {% for d in days if d.strftime('%A') != 'Sunday' %}
        <!-- Gün başlıkları -->
      {% for d in days if d.strftime('%A') != 'Sunday' %}
        <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-xl ring-1 ring-white/60 px-3 py-2 text-sm font-medium">
          {{ gunler_kisa[d.strftime('%a')] }}<br>
          <span class="text-stone-500 text-xs">{{ d.strftime('%d.%m') }}</span>
        </div>
      {% endfor %}
      {% endfor %}

      <!-- Saat satırları -->
      {% for t in slots %}
        <!-- Sol saat etiketi (yarı saydam) -->
  <div class="sticky left-0 px-2 py-3 text-sm font-medium pastel-pink-bg" style="background:rgba(244,114,182,0.28) !important;">
          {{ t.strftime('%H:%M') }}
        </div>

        <!-- Gün x Saat hücreleri -->
        {% for d in days if d.strftime('%A') != 'Sunday' %}
          {# FIX: Gün anahtarını sadece tarih ISO yap #}
          {% set day_key = d.date().isoformat() %}
          {% set time_key = t.strftime('%H:%M') %}
          {% set list_in_cell = by_cell.get((day_key, time_key), []) %}

          <div class="border border-white/50 p-2 min-h-[72px]">
            {% if list_in_cell|length > 0 %}
              {% for s in list_in_cell %}
                {% set left = s.spots_left|default(0) %}
                <div class="rounded-xl p-2 shadow-lg mb-2 last:mb-0
                            {% if left == 0 %} bg-gray-200 text-gray-600 cursor-not-allowed
                            {% elif s.user_joined %} bg-emerald-300/80 ring-1 ring-white/60
                            {% elif s.is_reserved %} bg-amber-300/80 ring-1 ring-white/60
                            {% else %} bg-gradient-to-r from-rose-300 to-violet-300
                            {% endif %}">
                  <div class="text-xs font-semibold flex items-center justify-between">
                    <span>{{ time_key }}</span>
                    <span class="text-[11px] opacity-80">{{ s.capacity }} kap · {{ left }} kal</span>
                  </div>

                  <form method="post" action="{{ url_for('reserve', session_id=s.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button
                      class="mt-1 w-full rounded-lg px-2 py-1 text-xs shadow transition
                             {% if left == 0 %} bg-gray-300 text-gray-500 cursor-not-allowed
                             {% elif s.user_joined %} bg-emerald-600/80 text-white hover:shadow-md
                             {% else %} bg-black/10 hover:bg-black/20
                             {% endif %}"
                      {% if left == 0 %}disabled{% endif %}>
                      {% if left == 0 %}Dolu{% elif s.user_joined %}Katıldın{% else %}Rezerve Et{% endif %}
                    </button>
                  </form>
                </div>
              {% endfor %}
            {% else %}
              <!-- Boş hücre: tam şeffaf, hover’da hafif cam -->
              <div class="w-full h-full rounded-lg border border-dashed border-white/40 bg-transparent py-6 text-center select-none transition
                          hover:border-white/80 hover:backdrop-blur-sm">
                <!-- Boş -->
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% endfor %}
    </div>

    <!-- Mobile Grid -->
    <div class="md:hidden grid gap-4">
      {% for d in days if d.strftime('%A') != 'Sunday' %}
        <div class="bg-white/10 rounded-xl p-4">
          <div class="font-semibold text-sm mb-3 text-center">
            {{ gunler[d.strftime('%A')] }}<br>
            <span class="text-stone-500 text-xs">{{ d.strftime('%d.%m.%Y') }}</span>
          </div>

          <div class="space-y-2">
            {% for t in slots %}
              {% set day_key = d.date().isoformat() %}
              {% set time_key = t.strftime('%H:%M') %}
              {% set list_in_cell = by_cell.get((day_key, time_key), []) %}

              {% if list_in_cell|length > 0 %}
                {% for s in list_in_cell %}
                  {% set left = s.spots_left|default(0) %}
                  <div class="rounded-lg p-3 shadow-md
                              {% if left == 0 %} bg-gray-200 text-gray-600
                              {% elif s.user_joined %} bg-emerald-300/80 ring-1 ring-white/60
                              {% elif s.is_reserved %} bg-amber-300/80 ring-1 ring-white/60
                              {% else %} bg-gradient-to-r from-rose-300 to-violet-300
                              {% endif %}">
                    <div class="flex items-center justify-between mb-2">
                      <span class="font-semibold text-sm">{{ t.strftime('%H:%M') }}</span>
                      <span class="text-xs opacity-80">{{ s.capacity }} kap · {{ left }} kal</span>
                    </div>

                    <form method="post" action="{{ url_for('reserve', session_id=s.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button
                        class="w-full rounded-lg px-3 py-2 text-sm shadow transition
                               {% if left == 0 %} bg-gray-300 text-gray-500 cursor-not-allowed
                               {% elif s.user_joined %} bg-emerald-600/80 text-white hover:shadow-md
                               {% else %} bg-black/10 hover:bg-black/20
                               {% endif %}"
                        {% if left == 0 %}disabled{% endif %}>
                        {% if left == 0 %}Dolu{% elif s.user_joined %}Katıldın{% else %}Rezerve Et{% endif %}
                      </button>
                    </form>
                  </div>
                {% endfor %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
